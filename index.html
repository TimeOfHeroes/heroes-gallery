<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>–ì–∞–ª–µ—Ä–µ—è –≥–µ—Ä–æ–µ–≤ ‚Äî —Ñ–∏–ª—å—Ç—Ä—ã –∏ –∫–∞—Ä—Ç–æ—á–∫–∏</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
:root { 
  color-scheme: light dark; 
  --hdrH: 70px; 
  --primary-color: #0a7;
  --secondary-color: #f3f3f3;
  --border-color: #ddd;
  --text-color: #111;
  --bg-color: #f7f7f7;
  --card-bg: #fff;
  --filter-bg: #fff;
  --checkbox-bg: #fff;
  --checkbox-border: #ccc;
  --header-bg: #fff;
  --header-text: #111;
}

@media (prefers-color-scheme: dark) {
  :root {
    --text-color: #eee;
    --bg-color: #1a1a1a;
    --card-bg: #2d2d2d;
    --filter-bg: #2d2d2d;
    --checkbox-bg: #3d3d3d;
    --checkbox-border: #555;
    --border-color: #444;
    --secondary-color: #3d3d3d;
    --header-bg: #2d2d2d;
    --header-text: #eee;
  }
}

* { box-sizing: border-box; }
body { 
  margin:0; 
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; 
  background: var(--bg-color); 
  color: var(--text-color);
  line-height: 1.4;
}
header { 
  position: sticky; 
  top: 0; 
  z-index: 100; 
  background: var(--header-bg); 
  color: var(--header-text);
  backdrop-filter: blur(8px); 
  border-bottom: 1px solid var(--border-color);
  box-shadow: 0 2px 10px rgba(0,0,0,.05);
}
.bar { 
  display: flex; 
  flex-wrap: wrap;
  gap: 10px; 
  align-items: center; 
  padding: 12px 16px; 
  max-width: 1400px;
  margin: 0 auto;
}
.title-container {
  flex: 1 0 auto;
  min-width: 200px;
}
h1 { 
  margin:0; 
  font-size:20px; 
  font-weight: 600;
  color: var(--header-text);
  line-height: 1.2;
}
.authors {
  font-size: 12px;
  color: var(--header-text);
  opacity: 0.7;
  margin: 2px 0 0;
  text-align: left;
  font-style: italic;
}
.header-controls {
  display: flex;
  gap: 8px;
  align-items: center;
  flex-wrap: wrap;
  flex: 2 1 auto;
  min-width: 0;
}
.search-wrapper {
  flex: 1;
  min-width: 180px;
}
.bar input[type="search"], .bar select, .bar button { 
  font-size:14px; 
  padding:8px 12px; 
  border: 1px solid var(--checkbox-border);
  border-radius: 8px;
  background: var(--card-bg);
  color: var(--text-color);
  transition: all 0.2s;
  width: 100%;
}
.bar input[type="search"]:focus, .bar select:focus { 
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 2px rgba(10, 119, 0, 0.1);
}
.btn { 
  border:1px solid var(--checkbox-border); 
  background: var(--card-bg); 
  color: var(--text-color);
  border-radius:8px; 
  cursor:pointer;
  transition: all 0.2s;
  font-weight: 500;
  white-space: nowrap;
}
.btn:hover {
  background: var(--secondary-color);
  border-color: var(--checkbox-border);
  transform: translateY(-1px);
}
.btn.primary { 
  background:var(--primary-color); 
  color:#fff; 
  border-color:var(--primary-color); 
}
.btn.primary:hover {
  background: #098;
  border-color: #098;
}

/* –û—Å–Ω–æ–≤–Ω–∞—è —Å–µ—Ç–∫–∞ */
.wrap { 
  display:block; 
  padding:20px; 
  min-height: calc(100vh - var(--hdrH));
  max-width: 1400px;
  margin: 0 auto;
}
@media (max-width: 1024px) { 
  .wrap { 
    padding: 16px;
    min-height: auto;
  } 
}

/* –í—ã–±–æ—Ä –≥–µ—Ä–æ–µ–≤ –≤ –≤–µ—Ä—Ö–Ω–µ–π –ø–∞–Ω–µ–ª–∏ */
.hero-select-wrapper {
  flex: 1;
  min-width: 180px;
  max-width: 250px;
  position: relative;
}
.hero-select-container {
  position: relative;
  width: 100%;
}
.hero-select-toggle {
  width: 100%;
  padding: 8px 12px;
  font-size: 14px;
  border: 1px solid var(--checkbox-border);
  border-radius: 8px;
  background: var(--card-bg);
  color: var(--text-color);
  cursor: pointer;
  text-align: left;
  display: flex;
  justify-content: space-between;
  align-items: center;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.hero-select-toggle:after {
  content: '‚ñº';
  font-size: 12px;
  opacity: 0.6;
  transition: transform 0.2s;
  flex-shrink: 0;
  margin-left: 8px;
}
.hero-select-toggle.show:after {
  transform: rotate(180deg);
}
.hero-checkboxes {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  margin-top: 4px;
  padding: 12px;
  max-height: 400px;
  overflow-y: auto;
  display: none;
  z-index: 101;
  box-shadow: 0 4px 20px rgba(0,0,0,.15);
}
.hero-checkboxes.show {
  display: block;
}
.hero-checkboxes-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
  padding-bottom: 10px;
  border-bottom: 1px solid var(--border-color);
}
.hero-checkboxes-header h3 {
  margin: 0;
  font-size: 14px;
  font-weight: 600;
  color: var(--text-color);
}
.hero-checkbox-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 8px;
  cursor: pointer;
  border-radius: 4px;
  transition: background 0.2s;
}
.hero-checkbox-item:hover {
  background: var(--secondary-color);
}
.hero-checkbox-item input[type="checkbox"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
  accent-color: var(--primary-color);
  background: var(--checkbox-bg);
  border: 1px solid var(--checkbox-border);
}
.hero-checkbox-item label {
  flex: 1;
  cursor: pointer;
  font-size: 14px;
  color: var(--text-color);
}
.hero-select-actions {
  display: flex;
  gap: 8px;
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid var(--border-color);
}
.hero-select-actions .btn {
  flex: 1;
  font-size: 13px;
  padding: 8px;
}
.hero-selected-count {
  font-size: 12px;
  color: var(--primary-color);
  font-weight: 500;
}

/* –§–∏–ª—å—Ç—Ä—ã */
.filters { 
  background: var(--filter-bg); 
  border:1px solid var(--border-color); 
  border-radius:12px;
  box-shadow: 0 2px 10px rgba(0,0,0,.05);
  width: 320px;
  position: fixed;
  top: var(--hdrH);
  left: 0;
  bottom: 0;
  max-height: calc(100vh - var(--hdrH));
  overflow: hidden;
  z-index: 99;
  border-radius: 0 12px 12px 0;
  box-shadow: 2px 0 15px rgba(0,0,0,.1);
  transform: translateX(-100%);
  transition: transform 0.3s ease;
  display: none;
}
.filters.show {
  transform: translateX(0);
  display: block;
}
.filters .panel { 
  padding:16px; 
  background: var(--filter-bg);
  display: flex;
  flex-direction: column;
  height: 100%;
  overflow-y: auto;
}
.filters .head { 
  display:flex; 
  align-items:center; 
  justify-content:space-between; 
  margin-bottom:16px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--border-color);
  background: var(--filter-bg);
  flex-shrink: 0;
}
.filters h2 { 
  margin:0; 
  font-size:18px; 
  font-weight: 600;
  color: var(--text-color);
}
.facet { 
  margin-bottom:20px; 
  background: var(--filter-bg);
  padding: 0;
  flex-shrink: 0;
}
.facet h3 { 
  margin:0 0 10px; 
  font-size:15px; 
  color: var(--text-color);
  font-weight: 500;
  background: var(--filter-bg);
  padding: 0;
}
.opts { 
  max-height:200px; 
  overflow-y: auto;
  overflow-x: hidden;
  border:1px solid var(--border-color); 
  border-radius:8px; 
  padding:8px; 
  background: var(--secondary-color);
}
.opt { 
  display:flex; 
  align-items:center; 
  gap:8px; 
  margin-bottom:6px; 
  font-size:14px; 
  cursor: pointer;
  padding: 4px 6px;
  border-radius: 4px;
  transition: background 0.2s;
  background: transparent;
  color: var(--text-color);
}
.opt:hover {
  background: rgba(0,0,0,.1);
}
.opt input[type="checkbox"] { 
  width: 18px; 
  height: 18px; 
  cursor: pointer; 
  flex-shrink: 0;
  accent-color: var(--primary-color);
  background: var(--checkbox-bg);
  border: 1px solid var(--checkbox-border);
}
.facet .actions { 
  display:flex; 
  gap:8px; 
  margin-top:10px; 
  background: var(--filter-bg);
}
.facet .actions .btn { 
  font-size:13px; 
  padding:6px 10px; 
}

/* –ö–Ω–æ–ø–∫–∞ –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã */
.apply-filters-container {
  margin-top: auto;
  padding-top: 16px;
  border-top: 1px solid var(--border-color);
  flex-shrink: 0;
}
.apply-filters-btn {
  width: 100%;
  padding: 12px;
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 8px;
}

/* –ö–æ–Ω—Ç–µ–Ω—Ç –∏ –∫–∞—Ä—Ç–æ—á–∫–∏ */
.content { 
  min-height:60vh; 
  width: 100%;
}
#count { 
  margin:0 0 20px; 
  color: var(--text-color);
  opacity: 0.7;
  font-size:15px;
  padding: 8px 0;
  font-weight: 500;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Å–µ—Ç–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ */
.cards { 
  display:grid; 
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); 
  gap:20px; 
  width: 100%;
}

@media (min-width: 1025px) {
  .cards { 
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); 
    gap:20px;
  }
}

@media (min-width: 1400px) {
  .cards { 
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); 
  }
}

@media (max-width: 1024px) {
  .cards { 
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); 
    gap:16px;
  }
}

@media (max-width: 768px) {
  .cards { 
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); 
    gap:14px;
  }
}

@media (max-width: 640px) {
  .cards { 
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
    gap:12px;
  }
}

@media (max-width: 480px) {
  .cards { 
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); 
    gap:10px;
  }
}

@media (max-width: 360px) {
  .cards { 
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); 
    gap:8px;
  }
}

.card { 
  border:1px solid var(--border-color); 
  border-radius:12px; 
  overflow:hidden; 
  background: var(--card-bg); 
  display:flex; 
  flex-direction:column; 
  transition: all 0.3s ease; 
  cursor:pointer;
  height: 100%;
  box-shadow: 0 2px 8px rgba(0,0,0,.08);
}
.card:hover { 
  box-shadow:0 8px 25px rgba(0,0,0,.12); 
  transform: translateY(-4px);
}

/* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞—Ä—Ç–∏–Ω–æ–∫ */
.thumb { 
  width:100%; 
  height: 190px;
  background: var(--secondary-color); 
  display:flex; 
  align-items:center; 
  justify-content:center; 
  overflow:hidden;
  position: relative;
}
.thumb img { 
  width: 100%;
  height: 100%;
  object-fit: contain;
  padding: 12px;
  transition: transform 0.3s;
}
.card:hover .thumb img {
  transform: scale(1.05);
}

@media (max-width: 768px) {
  .thumb { 
    height: 160px;
  }
}

@media (max-width: 480px) {
  .thumb { 
    height: 140px;
  }
}

.card h3 { 
  margin:12px 12px 6px; 
  font-size:16px; 
  font-weight: 600;
  line-height: 1.3;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  text-align: center;
  color: var(--text-color);
}

.meta { 
  margin:0 12px 6px; 
  color: var(--text-color);
  opacity: 0.8;
  display:flex; 
  gap:6px; 
  flex-wrap:wrap; 
  font-size:13px;
  line-height: 1.4;
  justify-content: center;
  text-align: center;
}
.stats { 
  margin:0 12px 12px; 
  display:flex; 
  gap:6px; 
  flex-wrap:wrap;
  justify-content: center;
}
.pill { 
  background: var(--secondary-color); 
  border:1px solid var(--border-color); 
  border-radius:999px; 
  padding:4px 8px; 
  font-size:12px;
  white-space: nowrap;
  font-weight: 500;
  color: var(--text-color);
}

/* –ö–Ω–æ–ø–∫–∞ –¥–ª—è —Ä–∞—Å–∫—Ä—ã—Ç–∏—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π –≤ –∫–∞—Ä—Ç–æ—á–∫–µ */
.toggle-abilities {
  background: none;
  border: none;
  color: var(--primary-color);
  font-size: 11px;
  cursor: pointer;
  padding: 2px 6px;
  margin: 0 auto 8px;
  text-decoration: underline;
  display: block;
}
.toggle-abilities:hover {
  color: #098;
}
.card-abilities-full {
  display: none;
  font-size: 11px;
  color: var(--text-color);
  opacity: 0.8;
  padding: 0 12px 8px;
  line-height: 1.4;
  border-top: 1px solid var(--border-color);
  margin-top: 4px;
  padding-top: 8px;
}

/* –ú–æ–¥–∞–ª–∫–∞ */
.modal { 
  position: fixed; 
  inset: 0; 
  background: rgba(0,0,0,.85); 
  display: none; 
  align-items: center; 
  justify-content: center; 
  padding: 20px; 
  z-index: 2000; 
}
.modal.show { 
  display: flex; 
  animation: fadeIn 0.3s ease;
}
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}
.dialog { 
  position: relative; 
  background: var(--card-bg); 
  color: var(--text-color); 
  max-width: 1000px; 
  width: min(1000px, 95vw); 
  max-height: 90vh; 
  overflow: hidden; 
  border-radius: 16px; 
  box-shadow: 0 25px 50px rgba(0,0,0,.3); 
  display: flex; 
  flex-direction: column;
}
.dialog .modal-content {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 24px;
  padding: 24px;
  overflow-y: auto;
  max-height: calc(90vh - 60px);
}
.dialog .image-container {
  display: flex;
  flex-direction: column;
  align-items: center;
}
.dialog img { 
  width: 100%;
  height: auto;
  max-height: 350px;
  object-fit: contain;
  border-radius: 12px;
  background: var(--secondary-color);
  padding: 15px;
}
.dialog .info-container {
  display: flex;
  flex-direction: column;
  overflow-wrap: break-word;
  word-wrap: break-word;
  hyphens: auto;
}
.dialog h2 { 
  margin: 0 0 12px; 
  font-size:28px; 
  font-weight: 700;
  color: var(--text-color);
  line-height: 1.2;
}
.dialog .meta { 
  display:flex; 
  gap:10px; 
  flex-wrap:wrap; 
  color: var(--text-color);
  opacity: 0.8;
  margin-bottom:10px; 
  font-size:15px;
  justify-content: flex-start;
}
.dialog .mStats { 
  display:flex; 
  gap:10px; 
  flex-wrap:wrap; 
  margin:12px 0 20px;
}
.dialog .mStats .pill { 
  font-size:14px; 
  padding:8px 12px;
  background: rgba(10, 119, 0, 0.1);
  border-color: var(--primary-color);
  color: var(--primary-color);
}
.pre { 
  white-space: pre-line; 
  background: var(--secondary-color); 
  border:1px solid var(--border-color); 
  border-radius:10px; 
  padding:12px; 
  font-size:15px; 
  overflow-wrap: break-word;
  word-break: break-word;
  line-height: 1.5;
  margin: 8px 0;
}
.close { 
  position: absolute; 
  top: 12px; 
  right: 12px; 
  border: none; 
  background: rgba(0,0,0,.7); 
  color: #fff; 
  font-size: 24px; 
  line-height: 1; 
  width: 40px;
  height: 40px;
  border-radius: 50%; 
  cursor: pointer; 
  z-index: 10;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}
.close:hover {
  background: rgba(0,0,0,.9);
  transform: scale(1.1);
}
.nav { 
  position: absolute; 
  top: 50%; 
  transform: translateY(-50%); 
  border: none; 
  background: rgba(0,0,0,.7); 
  color: #fff; 
  font-size: 28px; 
  line-height: 1; 
  width: 44px;
  height: 44px;
  padding: 0;
  border-radius: 50%; 
  cursor: pointer; 
  z-index: 10; 
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}
.nav:hover {
  background: rgba(0,0,0,.9);
  transform: translateY(-50%) scale(1.1);
}
.nav.prev { left: 12px; } 
.nav.next { right: 12px; }
.open-img { 
  margin-top:12px; 
  display:inline-block; 
  font-size:14px; 
  color:var(--primary-color); 
  text-decoration:none;
  font-weight: 500;
  transition: color 0.2s;
}
.open-img:hover {
  color: #098;
  text-decoration: underline;
}

@media (max-width: 860px) { 
  .dialog .modal-content { 
    grid-template-columns: 1fr; 
    padding: 20px;
    gap: 20px;
  }
  .dialog img { 
    max-height: 280px;
  }
  .dialog h2 {
    font-size: 24px;
  }
}

@media (max-width: 480px) {
  .dialog {
    width: 95vw;
    max-height: 95vh;
  }
  .dialog .modal-content { 
    padding: 16px;
    gap: 16px;
  }
  .dialog h2 { 
    font-size: 22px;
  }
  .dialog .meta {
    font-size: 14px;
  }
  .close {
    top: 8px;
    right: 8px;
    width: 36px;
    height: 36px;
    font-size: 20px;
  }
  .nav {
    width: 36px;
    height: 36px;
    font-size: 22px;
  }
}

/* –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ */
#empty { 
  display:none; 
  color: var(--text-color);
  opacity: 0.6;
  padding:40px 24px; 
  text-align: center;
  grid-column: 1 / -1;
  font-size: 16px;
}
#empty:before {
  content: "üòï";
  display: block;
  font-size: 48px;
  margin-bottom: 16px;
}

/* –ö–Ω–æ–ø–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ */
.info-btn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: var(--primary-color);
  color: white;
  border: none;
  font-size: 24px;
  cursor: pointer;
  z-index: 90;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 15px rgba(10, 119, 0, 0.3);
  transition: all 0.3s;
}
.info-btn:hover {
  background: #098;
  transform: scale(1.1);
  box-shadow: 0 6px 20px rgba(10, 119, 0, 0.4);
}

.info-modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.7);
  display: none;
  align-items: center;
  justify-content: center;
  padding: 20px;
  z-index: 2001;
}
.info-modal.show {
  display: flex;
}
.info-dialog {
  background: var(--card-bg);
  color: var(--text-color);
  border-radius: 16px;
  padding: 30px;
  max-width: 500px;
  width: 90%;
  box-shadow: 0 20px 60px rgba(0,0,0,.3);
  position: relative;
}
.info-dialog h2 {
  margin: 0 0 20px;
  color: var(--text-color);
  font-size: 24px;
  text-align: center;
}
.info-dialog p {
  margin: 0 0 15px;
  line-height: 1.6;
  color: var(--text-color);
  opacity: 0.9;
}
.info-dialog .clan {
  background: rgba(10, 119, 0, 0.1);
  padding: 15px;
  border-radius: 10px;
  margin: 20px 0;
  text-align: center;
  border: 1px solid var(--primary-color);
}
.info-dialog .clan strong {
  color: var(--primary-color);
  font-size: 18px;
}
.info-dialog .contact {
  background: rgba(0, 0, 0, 0.05);
  padding: 15px;
  border-radius: 10px;
  margin: 20px 0;
  text-align: center;
  border: 1px solid var(--border-color);
}
.info-dialog .contact a {
  color: var(--primary-color);
  text-decoration: none;
  font-weight: 500;
}
.info-dialog .contact a:hover {
  text-decoration: underline;
}
.info-dialog .date {
  text-align: center;
  font-style: italic;
  color: var(--text-color);
  opacity: 0.6;
  margin-top: 20px;
  padding-top: 15px;
  border-top: 1px solid var(--border-color);
}
.info-close {
  position: absolute;
  top: 15px;
  right: 15px;
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: var(--text-color);
  opacity: 0.7;
  transition: all 0.2s;
}
.info-close:hover {
  opacity: 1;
  color: var(--text-color);
}

/* –ú–æ–±–∏–ª—å–Ω—ã–π –æ—Ñ—Ñ–∫–∞–Ω–≤–∞—Å –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ */
@media (max-width: 1024px) {
  .filters { 
    position: fixed; 
    inset: 0; 
    background: rgba(0,0,0,.6); 
    display:none; 
    z-index:1000; 
    border:none; 
    padding: 0;
    margin: 0;
    width: 100vw;
    height: 100vh;
    transform: none;
  }
  .filters.show { 
    display:flex; 
    flex-direction: column;
  }
  .filters .panel { 
    position:relative;
    right:0; 
    top:0; 
    bottom:0; 
    width: min(380px, 90vw);
    max-width: 90vw;
    overflow:auto; 
    background: var(--filter-bg); 
    border-radius:12px 0 0 12px;
    padding: 20px;
    box-sizing: border-box;
    margin: 0;
    box-shadow: -2px 0 15px rgba(0,0,0,.1);
    height: 100%;
    flex: 1;
  }
  .filters .head { 
    position: sticky; 
    top:0; 
    background: var(--filter-bg); 
    padding-top:12px; 
    z-index:1;
    padding-bottom: 12px;
    margin: 0;
  }
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —à–∞–ø–∫–∏ */
@media (max-width: 1024px) {
  .bar {
    gap: 8px;
    padding: 10px 12px;
  }
  .header-controls {
    flex-direction: column;
    gap: 8px;
    width: 100%;
  }
  .hero-select-wrapper,
  .search-wrapper {
    width: 100%;
    max-width: none;
  }
  .title-container {
    text-align: center;
    margin-bottom: 8px;
  }
  .authors {
    text-align: center;
  }
}

@media (max-width: 768px) {
  h1 {
    font-size: 18px;
  }
  .authors {
    font-size: 11px;
  }
  .bar input[type="search"], .bar select, .bar button {
    font-size: 13px;
    padding: 7px 10px;
  }
  .info-btn {
    bottom: 15px;
    right: 15px;
    width: 44px;
    height: 44px;
    font-size: 20px;
  }
}

/* –ü–æ–¥–ª–æ–∂–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç—ã—Ö —Ñ–∏–ª—å—Ç—Ä–∞—Ö –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ */
@media (min-width: 1025px) {
  .filters.show ~ .wrap::before {
    content: '';
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.5);
    z-index: 98;
    pointer-events: none;
  }
}

/* –î–ª—è –æ—á–µ–Ω—å —É–∑–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
@media (max-width: 480px) {
  .bar {
    padding: 8px 10px;
  }
  .header-controls {
    gap: 6px;
  }
  .title-container {
    min-width: 100%;
  }
}

/* –î–ª—è –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã—Ö –º–æ–Ω–∏—Ç–æ—Ä–æ–≤ */
@media (max-width: 1200px) and (min-height: 900px) {
  .bar {
    flex-direction: column;
    align-items: stretch;
  }
  .title-container {
    text-align: center;
    margin-bottom: 10px;
  }
  .header-controls {
    width: 100%;
  }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ —Å–±—Ä–æ—Å–∞ —Ä—è–¥–æ–º */
.btn-group {
  display: flex;
  gap: 8px;
  flex: 0 0 auto;
}
.btn-group .btn {
  min-width: 80px;
}
</style>
</head>
<body>
<header>
<div class="bar">
  <div class="title-container">
    <h1>–í—Ä–µ–º—è –ì–µ—Ä–æ–µ–≤. –ì–∞–ª–µ—Ä–µ—è –≥–µ—Ä–æ–µ–≤.</h1>
    <div class="authors">–ï–≤–≥–µ–Ω–∏–π –ü–æ—Ç–∞—à–∫–æ –∏ –í–ª–∞–¥–∏–º–∏—Ä –ü–ª–æ—Ç–Ω–∏–∫–æ–≤, –∫–ª–∞–Ω "–†–æ–∂–¥–µ–Ω–Ω—ã–µ –≤ –°–°–°–†."</div>
  </div>
  
  <div class="header-controls">
    <div class="hero-select-wrapper">
      <div class="hero-select-container">
        <button id="heroSelectToggle" class="hero-select-toggle" aria-label="–í—ã–±–æ—Ä –≥–µ—Ä–æ–µ–≤">
          <span id="heroSelectText">–í—ã–±–µ—Ä–∏—Ç–µ –≥–µ—Ä–æ—è</span>
        </button>
        <div id="heroCheckboxes" class="hero-checkboxes">
          <div class="hero-checkboxes-header">
            <h3>–í—ã–±–µ—Ä–∏—Ç–µ –≥–µ—Ä–æ–µ–≤</h3>
            <span id="heroSelectedCount" class="hero-selected-count">0 –≤—ã–±—Ä–∞–Ω–æ</span>
          </div>
          <div id="heroCheckboxesList"></div>
          <div class="hero-select-actions">
            <button id="selectAllHeroes" class="btn">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
            <button id="deselectAllHeroes" class="btn">–°–Ω—è—Ç—å –≤—Å–µ</button>
            <button id="applyHeroSelection" class="btn primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="search-wrapper">
      <input id="q" type="search" class="btn" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏/—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏">
    </div>
    
    <div style="display: flex; gap: 8px; flex: 0 0 auto;">
      <select id="sortBy" class="btn" title="–ü–æ–ª–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏" style="min-width: 100px;">
        <option value="–°–∏–ª–∞" selected>–°–∏–ª–∞</option>
        <option value="–ê—Ç–∞–∫–∞">–ê—Ç–∞–∫–∞</option>
        <option value="–ó–∞—â–∏—Ç–∞">–ó–∞—â–∏—Ç–∞</option>
        <option value="–ñ–∏–∑–Ω–∏">–ñ–∏–∑–Ω–∏</option>
        <option value="–ì–µ—Ä–æ–π">–ò–º—è</option>
      </select>
      
      <select id="sortDir" class="btn" title="–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ" style="min-width: 90px;">
        <option value="desc" selected>–£–±—ã–≤.</option>
        <option value="asc">–í–æ–∑—Ä.</option>
      </select>
    </div>
    
    <div class="btn-group">
      <button id="openFilters" class="btn">–§–∏–ª—å—Ç—Ä—ã</button>
      <button id="resetAll" class="btn">–°–±—Ä–æ—Å–∏—Ç—å</button>
    </div>
  </div>
</div>
</header>

<!-- –§–∏–ª—å—Ç—Ä—ã (—Å–∫—Ä—ã—Ç–∞—è –ø–∞–Ω–µ–ª—å –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö) -->
<aside id="filters" class="filters">
<div class="panel">
<div class="head">
<h2>–§–∏–ª—å—Ç—Ä—ã</h2>
<div style="display: flex; gap: 8px;">
  <button id="applyFiltersBtn" class="btn primary" style="flex: 1;">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
  <button id="closeFilters" class="btn">–ó–∞–∫—Ä—ã—Ç—å</button>
</div>
</div>
<div class="facet" data-facet="element">
      <h3>–°—Ç–∏—Ö–∏—è</h3>
      <div class="opts" id="facet-element"></div>
      <div class="actions">
        <button class="btn" data-action="all" data-facet="element">–í—Å–µ</button>
        <button class="btn" data-action="none" data-facet="element">–°–Ω—è—Ç—å</button>
      </div>
    </div>

    <div class="facet" data-facet="stars">
      <h3>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤–µ–∑–¥</h3>
      <div class="opts" id="facet-stars"></div>
      <div class="actions">
        <button class="btn" data-action="all" data-facet="stars">–í—Å–µ</button>
        <button class="btn" data-action="none" data-facet="stars">–°–Ω—è—Ç—å</button>
      </div>
    </div>

    <div class="facet" data-facet="mana">
      <h3>–°–∫–æ—Ä–æ—Å—Ç—å –º–∞–Ω—ã</h3>
      <div class="opts" id="facet-mana"></div>
      <div class="actions">
        <button class="btn" data-action="all" data-facet="mana">–í—Å–µ</button>
        <button class="btn" data-action="none" data-facet="mana">–°–Ω—è—Ç—å</button>
      </div>
    </div>

    <div class="facet" data-facet="attackType">
      <h3>–°–ø–æ—Å–æ–± –∞—Ç–∞–∫–∏</h3>
      <div class="opts" id="facet-attackType"></div>
      <div class="actions">
        <button class="btn" data-action="all" data-facet="attackType">–í—Å–µ</button>
        <button class="btn" data-action="none" data-facet="attackType">–°–Ω—è—Ç—å</button>
      </div>
    </div>

    <div class="facet" data-facet="summon">
      <h3>–ú–µ—Å—Ç–æ –ø—Ä–∏–∑—ã–≤–∞</h3>
      <div class="opts" id="facet-summon"></div>
      <div class="actions">
        <button class="btn" data-action="all" data-facet="summon">–í—Å–µ</button>
        <button class="btn" data-action="none" data-facet="summon">–°–Ω—è—Ç—å</button>
      </div>
    </div>

    <div class="facet" data-facet="clazz">
      <h3>–ö–ª–∞—Å—Å</h3>
      <div class="opts" id="facet-clazz"></div>
      <div class="actions">
        <button class="btn" data-action="all" data-facet="clazz">–í—Å–µ</button>
        <button class="btn" data-action="none" data-facet="clazz">–°–Ω—è—Ç—å</button>
      </div>
    </div>
    
    <div class="apply-filters-container">
      <button id="applyFiltersMobileBtn" class="btn primary apply-filters-btn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
    </div>
  </div>
</aside>

<div class="wrap">
<!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
<section class="content">
  <div id="count">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  <div id="cards" class="cards"></div>
  <div id="empty" style="display:none; color:#666; padding:24px;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ò–∑–º–µ–Ω–∏—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã.</div>
</section>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ -->
<div id="modal" class="modal" role="dialog" aria-modal="true">
<div class="dialog">
<button id="mClose" class="close" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
<button id="mPrev" class="nav prev" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∏–π">‚Äπ</button>
<button id="mNext" class="nav next" aria-label="–°–ª–µ–¥—É—é—â–∏–π">‚Ä∫</button>
<div class="modal-content">
  <div class="image-container">
    <img id="mImg" src="" alt="">
    <a id="mOpenImg" class="open-img" href="#" target="_blank" rel="noopener">–û—Ç–∫—Ä—ã—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ</a>
  </div>
  <div class="info-container">
    <h2 id="mName"></h2>
    <div id="mMeta1" class="meta"></div>
    <div id="mMeta2" class="meta"></div>
    <div id="mStats" class="mStats"></div>
    <h3>–°–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏</h3>
    <div id="mAbilities" class="pre"></div>
    <h3>–ü–∞—Å—Å–∏–≤–Ω—ã–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏</h3>
    <div id="mPassive" class="pre"></div>
  </div>
</div>
</div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ -->
<div id="infoModal" class="info-modal">
  <div class="info-dialog">
    <button id="infoClose" class="info-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
    <h2>–û –≥–∞–ª–µ—Ä–µ–µ –≥–µ—Ä–æ–µ–≤</h2>
    <p>–≠—Ç–∞ –≥–∞–ª–µ—Ä–µ—è —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥–µ—Ä–æ—è—Ö –∏–≥—Ä—ã "–í—Ä–µ–º—è –ì–µ—Ä–æ–µ–≤", –∏—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞—Ö –∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—è—Ö.</p>
    <div class="clan">
      <strong>–†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ:</strong><br>
      –ï–≤–≥–µ–Ω–∏–π –ü–æ—Ç–∞—à–∫–æ –∏ –í–ª–∞–¥–∏–º–∏—Ä –ü–ª–æ—Ç–Ω–∏–∫–æ–≤<br>
      <strong>–ö–ª–∞–Ω: "–†–æ–∂–¥–µ–Ω–Ω—ã–µ –≤ –°–°–°–†."</strong><br>
      —Å–∫—Ä–∏–Ω—ã –≥–µ—Ä–æ–µ–≤ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã –≤–µ–ª–∏–∫–∏–º –∏ –º–æ–≥—É—á–∏–º –ö–æ–∑—ã—Ä–µ–º
    </div>
    <div class="contact">
      <strong>–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å:</strong><br>
      –ù–∞—à–ª–∏ –æ—à–∏–±–∫—É –∏–ª–∏ –µ—Å—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è?<br>
      –ü–∏—à–∏—Ç–µ: <a href="mailto:master-Erasm@yandex.ru">master-Erasm@yandex.ru</a>
    </div>
    <p>–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å —É—á–µ—Ç–æ–º –Ω–æ–≤—ã—Ö –≥–µ—Ä–æ–µ–≤ –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –±–∞–ª–∞–Ω—Å–µ –∏–≥—Ä—ã.</p>
    <p class="date">–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: <span id="updateDate"></span></p>
  </div>
</div>

<!-- –ö–Ω–æ–ø–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ -->
<button id="infoBtn" class="info-btn" title="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è">i</button>

<script>
// –ò–º–µ–Ω–∞ –∫–æ–ª–æ–Ω–æ–∫ (—Ç–æ—á–Ω–æ –∫–∞–∫ –≤ CSV)
const F = {
id: 'id',
name: '–ì–µ—Ä–æ–π',
element: '–°—Ç–∏—Ö–∏—è',
stars: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤–µ–∑–¥',
mana: '–°–∫–æ—Ä–æ—Å—Ç—å –º–∞–Ω—ã',
power: '–°–∏–ª–∞',
attack: '–ê—Ç–∞–∫–∞',
defense: '–ó–∞—â–∏—Ç–∞',
hp: '–ñ–∏–∑–Ω–∏',
attackType: '–°–ø–æ—Å–æ–± –∞—Ç–∞–∫–∏',
abilities: '–°–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏',
passive: '–ü–∞—Å—Å–∏–≤–Ω—ã–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏',
summon: '–ú–µ—Å—Ç–æ –ø—Ä–∏–∑—ã–≤–∞',
clazz: '–ö–ª–∞—Å—Å',
image: '–ö–∞—Ä—Ç–∏–Ω–∫–∞'
};
const DATA_URL = 'heroes.csv?ts=' + Date.now();

const els = {
  q: document.getElementById('q'),
  sortBy: document.getElementById('sortBy'),
  sortDir: document.getElementById('sortDir'),
  resetAll: document.getElementById('resetAll'),
  openFilters: document.getElementById('openFilters'),
  closeFilters: document.getElementById('closeFilters'),
  applyFiltersBtn: document.getElementById('applyFiltersBtn'),
  applyFiltersMobileBtn: document.getElementById('applyFiltersMobileBtn'),
  heroSelectToggle: document.getElementById('heroSelectToggle'),
  heroSelectText: document.getElementById('heroSelectText'),
  heroCheckboxes: document.getElementById('heroCheckboxes'),
  heroCheckboxesList: document.getElementById('heroCheckboxesList'),
  heroSelectedCount: document.getElementById('heroSelectedCount'),
  selectAllHeroes: document.getElementById('selectAllHeroes'),
  deselectAllHeroes: document.getElementById('deselectAllHeroes'),
  applyHeroSelection: document.getElementById('applyHeroSelection'),
  filters: document.getElementById('filters'),
  count: document.getElementById('count'),
  cards: document.getElementById('cards'),
  empty: document.getElementById('empty'),
  facet: {
    element: document.getElementById('facet-element'),
    stars: document.getElementById('facet-stars'),
    mana: document.getElementById('facet-mana'),
    attackType: document.getElementById('facet-attackType'),
    summon: document.getElementById('facet-summon'),
    clazz: document.getElementById('facet-clazz'),
  },
  modal: document.getElementById('modal'),
  mClose: document.getElementById('mClose'),
  mPrev: document.getElementById('mPrev'),
  mNext: document.getElementById('mNext'),
  mImg: document.getElementById('mImg'),
  mOpenImg: document.getElementById('mOpenImg'),
  mName: document.getElementById('mName'),
  mMeta1: document.getElementById('mMeta1'),
  mMeta2: document.getElementById('mMeta2'),
  mStats: document.getElementById('mStats'),
  mAbilities: document.getElementById('mAbilities'),
  mPassive: document.getElementById('mPassive'),
  infoModal: document.getElementById('infoModal'),
  infoBtn: document.getElementById('infoBtn'),
  infoClose: document.getElementById('infoClose'),
  updateDate: document.getElementById('updateDate')
};

let allRows = [];
let viewRows = [];
let currentIdx = -1;
let allHeroNames = [];
let filteredHeroNames = []; // –ì–µ—Ä–æ–∏ –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤

const selected = {
  element: new Set(),
  stars: new Set(),
  mana: new Set(),
  attackType: new Set(),
  summon: new Set(),
  clazz: new Set(),
  heroes: new Set()
};

function toNum(v){ const n = Number(String(v).replace(',', '.')); return Number.isFinite(n) ? n : null; }
function uniq(values){ return [...new Set(values.filter(v => v!==undefined && v!==null && String(v).trim()!==''))]; }
function sortAlpha(a,b){ return String(a).localeCompare(String(b), 'ru', {numeric:true}); }

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Å–∫–æ—Ä–æ—Å—Ç–∏ –º–∞–Ω—ã –≤ –∑–∞–¥–∞–Ω–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
function sortMana(a, b) {
  const order = ['–û—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–æ', '–ú–µ–¥–ª–µ–Ω–Ω–æ', '–°—Ä–µ–¥–Ω–µ', '–ë—ã—Å—Ç—Ä–æ', '–û—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ', '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–æ –±—ã—Å—Ç—Ä–æ'];
  const indexA = order.indexOf(a);
  const indexB = order.indexOf(b);
  
  if (indexA === -1 && indexB === -1) return String(a).localeCompare(String(b), 'ru');
  if (indexA === -1) return 1;
  if (indexB === -1) return -1;
  
  return indexA - indexB;
}

function sortNumericAsc(a,b){ const na=toNum(a), nb=toNum(b); return (na??Infinity) - (nb??Infinity); }

function fileCellToUrl(v){
  if (!v) return '';
  const s = String(v).trim();
  const mParen = s.match(/\((https?:\/\/[^)]+)\)/i);
  if (mParen) return mParen[1];
  const mAny = s.match(/https?:\/\/\S+/i);
  if (mAny) return mAny[0].replace(/[),]+$/,'');
  try {
    const arr = JSON.parse(s);
    if (Array.isArray(arr) && arr.length && arr[0].url) return arr[0].url;
  } catch(e){}
  return '';
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –≥–µ—Ä–æ–µ–≤
function updateHeroSelectDisplay() {
  const count = selected.heroes.size;
  els.heroSelectedCount.textContent = `${count} –≤—ã–±—Ä–∞–Ω–æ`;
  
  if (count === 0) {
    els.heroSelectText.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –≥–µ—Ä–æ—è';
  } else if (count === 1) {
    const heroName = Array.from(selected.heroes)[0];
    els.heroSelectText.textContent = heroName;
  } else if (count === allHeroNames.length) {
    els.heroSelectText.textContent = '–í—Å–µ –≥–µ—Ä–æ–∏';
  } else {
    const firstHero = Array.from(selected.heroes)[0];
    els.heroSelectText.textContent = `${firstHero} –∏ –µ—â–µ ${count - 1}`;
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–µ–∫–±–æ–∫—Å–æ–≤ –≥–µ—Ä–æ–µ–≤ (–æ–±–Ω–æ–≤–ª–µ–Ω–∞!)
function updateHeroCheckboxes() {
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º filteredHeroNames –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ allHeroNames
  const heroNamesToShow = filteredHeroNames.length > 0 ? filteredHeroNames : allHeroNames;
  
  els.heroCheckboxesList.innerHTML = heroNamesToShow.map(name => {
    const isSelected = selected.heroes.has(name);
    return `
      <div class="hero-checkbox-item">
        <input type="checkbox" id="hero-${name}" data-hero="${name}" ${isSelected ? 'checked' : ''}>
        <label for="hero-${name}">${name}</label>
      </div>
    `;
  }).join('');
  
  // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤
  els.heroCheckboxesList.querySelectorAll('input[type="checkbox"]').forEach(cb => {
    cb.addEventListener('change', function() {
      const heroName = this.getAttribute('data-hero');
      if (this.checked) {
        selected.heroes.add(heroName);
      } else {
        selected.heroes.delete(heroName);
      }
      updateHeroSelectDisplay();
    });
  });
  
  updateHeroSelectDisplay();
}

function buildFacet(container, values, facetKey){
  let opts = uniq(values);
  
  // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏ –º–∞–Ω—ã
  if (facetKey === 'mana') {
    opts.sort(sortMana);
  } else if (facetKey === 'stars') {
    opts.sort(sortNumericAsc);
  } else {
    opts.sort(sortAlpha);
  }
  
  container.innerHTML = opts.map(val => {
    const checked = selected[facetKey].size ? (selected[facetKey].has(String(val)) ? 'checked' : '') : '';
    return `<label class="opt"><input type="checkbox" data-facet="${facetKey}" value="${String(val).replace(/"/g,'&quot;')}" ${checked}><span>${String(val)}</span></label>`;
  }).join('');
  
  container.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
    cb.addEventListener('change', ()=>{
      const set = selected[facetKey];
      if (cb.checked) set.add(cb.value); else set.delete(cb.value);
    });
  });
}

function initAllFacets(rows){
  buildFacet(els.facet.element, rows.map(r=>r[F.element]), 'element');
  buildFacet(els.facet.stars,   rows.map(r=>r[F.stars]),   'stars');
  buildFacet(els.facet.mana,    rows.map(r=>r[F.mana]),    'mana');
  buildFacet(els.facet.attackType, rows.map(r=>r[F.attackType]), 'attackType');
  buildFacet(els.facet.summon,  rows.map(r=>r[F.summon]),  'summon');
  buildFacet(els.facet.clazz,   rows.map(r=>r[F.clazz]),   'clazz');
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö –≥–µ—Ä–æ–µ–≤
  allHeroNames = uniq(rows.map(r => r[F.name])).sort(sortAlpha);
  filteredHeroNames = [...allHeroNames]; // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ—Ö –≥–µ—Ä–æ–µ–≤
  updateHeroCheckboxes();
}

function selectAll(facetKey){
  const values = uniq(allRows.map(r=>{
    switch(facetKey){
      case 'element': return r[F.element];
      case 'stars': return r[F.stars];
      case 'mana': return r[F.mana];
      case 'attackType': return r[F.attackType];
      case 'summon': return r[F.summon];
      case 'clazz': return r[F.clazz];
      default: return null;
    }
  })).filter(v => v !== null);
  
  selected[facetKey] = new Set(values.map(String));
  initAllFacets(allRows);
}

function selectNone(facetKey){
  selected[facetKey].clear();
  initAllFacets(allRows);
}

function renderCards(rows){
  if (!rows.length){
    els.cards.innerHTML = '';
    els.empty.style.display = 'block';
    return;
  }
  els.empty.style.display = 'none';
  els.cards.innerHTML = rows.map((r, i)=>{
    const img = fileCellToUrl(r[F.image]);
    const abilitiesFull = String(r[F.abilities]||'');
    const hasAbilities = abilitiesFull.trim().length > 0;
    
    return `
      <article class="card" data-idx="${i}">
        <div class="thumb">
          ${img ? `<img src="${img}" alt="${r[F.name]||''}" loading="lazy" onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML='<div style=\\'color: #999; padding: 20px; text-align: center;\\'>–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>';" />` : '<div style="color: #999; padding: 20px; text-align: center;">–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>'}
        </div>
        <h3>${r[F.name]||''}</h3>
        <div class="meta">
          <span>${r[F.element]||''}</span> ‚Ä¢
          <span>${r[F.stars]||''}‚òÖ</span> ‚Ä¢
          <span>${r[F.mana]||''}</span>
        </div>
        <div class="meta">
          <span>${r[F.attackType]||''}</span> ‚Ä¢
          <span>${r[F.summon]||''}</span> ‚Ä¢
          <span>${r[F.clazz]||''}</span>
        </div>
        <div class="stats">
          <span class="pill">–°: ${r[F.power]||''}</span>
          <span class="pill">–ê: ${r[F.attack]||''}</span>
          <span class="pill">–ó: ${r[F.defense]||''}</span>
          <span class="pill">–ñ: ${r[F.hp]||''}</span>
        </div>
        ${hasAbilities ? `
          <button class="toggle-abilities" data-idx="${i}">–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏</button>
          <div class="card-abilities-full" id="abilities-${i}">${abilitiesFull.replace(/\n/g, '<br>')}</div>
        ` : ''}
      </article>
    `;
  }).join('');
  
  // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π
  document.querySelectorAll('.toggle-abilities').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      const idx = this.getAttribute('data-idx');
      const fullAbilities = document.getElementById(`abilities-${idx}`);
      if (fullAbilities.style.display === 'block') {
        fullAbilities.style.display = 'none';
        this.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏';
      } else {
        fullAbilities.style.display = 'block';
        this.textContent = '–°–∫—Ä—ã—Ç—å —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏';
      }
    });
  });
}

function fillModal(h){
  const img = fileCellToUrl(h[F.image]);
  els.mImg.src = img || '';
  els.mImg.alt = h[F.name] || '';
  els.mOpenImg.href = img || '#';
  els.mOpenImg.style.display = img ? 'inline-block' : 'none';

  els.mName.textContent = h[F.name] || '';
  els.mMeta1.innerHTML = `
    <span>${h[F.element]||''}</span>
    <span>${(h[F.stars]||'') ? (h[F.stars]+'‚òÖ') : ''}</span>
    <span>${h[F.mana]||''}</span>
  `;
  els.mMeta2.innerHTML = `
    <span>${h[F.attackType]||''}</span>
    <span>${h[F.summon]||''}</span>
    <span>${h[F.clazz]||''}</span>
  `;
  els.mStats.innerHTML = `
    <span class="pill">–°–∏–ª–∞: ${h[F.power]||''}</span>
    <span class="pill">–ê–¢–ö: ${h[F.attack]||''}</span>
    <span class="pill">–ó–ê–©: ${h[F.defense]||''}</span>
    <span class="pill">HP: ${h[F.hp]||''}</span>
  `;
  els.mAbilities.textContent = h[F.abilities] || '‚Äî';
  els.mPassive.textContent = h[F.passive] || '‚Äî';
}

function openModal(idx){
  if (!viewRows.length) return;
  currentIdx = idx;
  fillModal(viewRows[currentIdx]);
  els.modal.classList.add('show');
  document.body.style.overflow = 'hidden';
}

function closeModal(){
  els.modal.classList.remove('show');
  document.body.style.overflow = '';
  currentIdx = -1;
}

function go(delta){
  if (currentIdx < 0 || !viewRows.length) return;
  currentIdx = (currentIdx + delta + viewRows.length) % viewRows.length;
  fillModal(viewRows[currentIdx]);
}

function applyFilters(){
  const q = els.q.value.trim().toLowerCase();
  
  viewRows = allRows.filter(r=>{
    const tName = String(r[F.name]||'').toLowerCase();
    const tAbil = String(r[F.abilities]||'').toLowerCase();
    const passQ = !q || tName.includes(q) || tAbil.includes(q);
    const passElem   = selected.element.size===0   || selected.element.has(String(r[F.element]));
    const passStars  = selected.stars.size===0     || selected.stars.has(String(r[F.stars]));
    const passMana   = selected.mana.size===0      || selected.mana.has(String(r[F.mana]));
    const passAtkT   = selected.attackType.size===0|| selected.attackType.has(String(r[F.attackType]));
    const passSummon = selected.summon.size===0    || selected.summon.has(String(r[F.summon]));
    const passClazz  = selected.clazz.size===0     || selected.clazz.has(String(r[F.clazz]));
    const passHeroes = selected.heroes.size===0    || selected.heroes.has(String(r[F.name]));
    
    return passQ && passElem && passStars && passMana && passAtkT && passSummon && passClazz && passHeroes;
  });

  const by = els.sortBy.value;
  const dir = els.sortDir.value;
  viewRows.sort((a,b)=>{
    const av = a[by], bv = b[by];
    const an = toNum(av), bn = toNum(bv);
    let cmp;
    if (an!=null && bn!=null) cmp = an - bn;
    else cmp = String(av||'').localeCompare(String(bv||''), 'ru', {numeric:true});
    return dir==='asc' ? cmp : -cmp;
  });

  els.count.textContent = `–ù–∞–π–¥–µ–Ω–æ: ${viewRows.length}`;
  renderCards(viewRows);
  
  // –í–∞–∂–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≥–µ—Ä–æ–µ–≤ –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
  filteredHeroNames = uniq(viewRows.map(r => r[F.name])).sort(sortAlpha);
  updateHeroCheckboxes();
}

function attachEvents(){
  [els.q, els.sortBy, els.sortDir].forEach(el=>{
    el.addEventListener('input', applyFilters);
    el.addEventListener('change', applyFilters);
  });
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ –≥–µ—Ä–æ–µ–≤
  els.heroSelectToggle.addEventListener('click', (e) => {
    els.heroSelectToggle.classList.toggle('show');
    els.heroCheckboxes.classList.toggle('show');
    e.stopPropagation();
  });
  
  els.selectAllHeroes.addEventListener('click', () => {
    // –í—ã–±–∏—Ä–∞–µ–º –≤—Å–µ—Ö –≥–µ—Ä–æ–µ–≤ –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞
    selected.heroes = new Set(filteredHeroNames);
    updateHeroCheckboxes();
  });
  
  els.deselectAllHeroes.addEventListener('click', () => {
    selected.heroes.clear();
    updateHeroCheckboxes();
  });
  
  // –ö–Ω–æ–ø–∫–∞ "–ü—Ä–∏–º–µ–Ω–∏—Ç—å" –¥–ª—è –≤—ã–±–æ—Ä–∞ –≥–µ—Ä–æ–µ–≤
  els.applyHeroSelection.addEventListener('click', () => {
    els.heroSelectToggle.classList.remove('show');
    els.heroCheckboxes.classList.remove('show');
    applyFilters(); // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –≥–µ—Ä–æ–µ–≤
  });
  
  // –ó–∞–∫—Ä—ã—Ç–∏–µ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
  document.addEventListener('click', (e) => {
    if (!els.heroSelectToggle.contains(e.target) && !els.heroCheckboxes.contains(e.target)) {
      els.heroSelectToggle.classList.remove('show');
      els.heroCheckboxes.classList.remove('show');
    }
  });
  
  document.querySelectorAll('.facet .actions button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const facetKey = btn.dataset.facet;
      if (btn.dataset.action === 'all') selectAll(facetKey);
      else selectNone(facetKey);
    });
  });
  
  els.resetAll.addEventListener('click', ()=>{
    els.q.value = '';
    els.sortBy.value = '–°–∏–ª–∞';
    els.sortDir.value = 'desc';
    Object.keys(selected).forEach(k => selected[k].clear());
    filteredHeroNames = [...allHeroNames]; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –≥–µ—Ä–æ–µ–≤
    initAllFacets(allRows);
    applyFilters();
  });
  
  // –ö–Ω–æ–ø–∫–∞ "–ü—Ä–∏–º–µ–Ω–∏—Ç—å" –≤ —Ñ–∏–ª—å—Ç—Ä–∞—Ö
  els.applyFiltersBtn.addEventListener('click', () => {
    applyFilters();
    els.filters.classList.remove('show');
    document.body.style.overflow = '';
  });
  
  els.applyFiltersMobileBtn.addEventListener('click', () => {
    applyFilters();
    els.filters.classList.remove('show');
    document.body.style.overflow = '';
  });
  
  els.cards.addEventListener('click', (e)=>{
    if (e.target.classList.contains('toggle-abilities')) {
      return;
    }
    const card = e.target.closest('.card');
    if (!card) return;
    const idx = Number(card.dataset.idx);
    if (Number.isFinite(idx)) openModal(idx);
  });
  
  els.mClose.addEventListener('click', closeModal);
  els.mPrev.addEventListener('click', ()=>go(-1));
  els.mNext.addEventListener('click', ()=>go(1));
  
  els.modal.addEventListener('click', (e)=>{
    if (e.target === els.modal) closeModal();
  });
  
  window.addEventListener('keydown', (e)=>{
    if (!els.modal.classList.contains('show')) return;
    if (e.key === 'Escape') closeModal();
    if (e.key === 'ArrowLeft') go(-1);
    if (e.key === 'ArrowRight') go(1);
  });
  
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
  els.openFilters.addEventListener('click', ()=>{
    els.filters.classList.add('show');
    document.body.style.overflow = 'hidden';
  });
  
  els.closeFilters.addEventListener('click', ()=>{
    els.filters.classList.remove('show');
    document.body.style.overflow = '';
  });
  
  // –ö–ª–∏–∫ –ø–æ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏—é –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —Ñ–∏–ª—å—Ç—Ä—ã
  els.filters.addEventListener('click', (e)=>{
    if (e.target === els.filters) {
      els.filters.classList.remove('show');
      document.body.style.overflow = '';
    }
  });
  
  // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –º–æ–¥–∞–ª–∫–∞
  els.infoBtn.addEventListener('click', ()=>{
    els.infoModal.classList.add('show');
    document.body.style.overflow = 'hidden';
  });
  
  els.infoClose.addEventListener('click', ()=>{
    els.infoModal.classList.remove('show');
    document.body.style.overflow = '';
  });
  
  els.infoModal.addEventListener('click', (e)=>{
    if (e.target === els.infoModal) {
      els.infoModal.classList.remove('show');
      document.body.style.overflow = '';
    }
  });
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  const now = new Date();
  const options = { year: 'numeric', month: 'long', day: 'numeric' };
  els.updateDate.textContent = now.toLocaleDateString('ru-RU', options);
}

Papa.parse(DATA_URL, {
  download:true,
  header:true,
  skipEmptyLines:true,
  complete: (res)=>{
    allRows = res.data || [];
    if (!allRows.length){ 
      els.count.textContent = '–î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ heroes.csv'; 
      return; 
    }
    initAllFacets(allRows);
    attachEvents();
    applyFilters();
  },
  error: (e)=> { 
    console.error('–û—à–∏–±–∫–∞ CSV:', e); 
    els.count.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ CSV.'; 
  }
});
</script>
</body>
</html>
