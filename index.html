<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>Галерея героев — фильтры и карточки</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
:root { 
  color-scheme: light dark; 
  --hdrH: 70px; 
  --primary-color: #0a7;
  --secondary-color: #f3f3f3;
  --border-color: #ddd;
  --text-color: #111;
  --bg-color: #f7f7f7;
  --card-bg: #fff;
  --filter-bg: #fff;
  --checkbox-bg: #fff;
  --checkbox-border: #ccc;
  --header-bg: #fff;
  --header-text: #111;
  --accent-color: #2563eb;
}

@media (prefers-color-scheme: dark) {
  :root {
    --text-color: #eee;
    --bg-color: #1a1a1a;
    --card-bg: #2d2d2d;
    --filter-bg: #2d2d2d;
    --checkbox-bg: #3d3d3d;
    --checkbox-border: #555;
    --border-color: #444;
    --secondary-color: #3d3d3d;
    --header-bg: #2d2d2d;
    --header-text: #eee;
    --accent-color: #3b82f6;
  }
}

* { box-sizing: border-box; }
body { 
  margin:0; 
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; 
  background: var(--bg-color); 
  color: var(--text-color);
  line-height: 1.4;
}
header { 
  position: sticky; 
  top: 0; 
  z-index: 100; 
  background: var(--header-bg); 
  color: var(--header-text);
  backdrop-filter: blur(8px); 
  border-bottom: 1px solid var(--border-color);
  box-shadow: 0 2px 10px rgba(0,0,0,.05);
}

/* Основной контейнер */
.container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 16px;
}

/* Верхняя панель */
.top-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 0;
  gap: 16px;
}

/* Логотип и заголовок */
.brand {
  display: flex;
  flex-direction: column;
  min-width: 200px;
}
.brand h1 {
  margin: 0;
  font-size: 20px;
  font-weight: 600;
  color: var(--header-text);
  line-height: 1.2;
}
.copyright {
  font-size: 12px;
  color: var(--header-text);
  opacity: 0.7;
  margin: 2px 0 0;
  text-align: left;
  font-style: italic;
}

/* Центральная группа: выбор героя + поиск */
.center-group {
  display: flex;
  flex: 1;
  gap: 8px;
  min-width: 0;
  max-width: 600px;
}

/* Выбор героя */
.hero-select-wrapper {
  flex: 1;
  min-width: 200px;
  position: relative;
}
.hero-select-container {
  position: relative;
  width: 100%;
}
.hero-select-toggle {
  width: 100%;
  padding: 8px 36px 8px 12px;
  font-size: 14px;
  border: 1px solid var(--checkbox-border);
  border-radius: 8px;
  background: var(--card-bg);
  color: var(--text-color);
  cursor: pointer;
  text-align: left;
  display: flex;
  justify-content: space-between;
  align-items: center;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.hero-select-toggle:after {
  content: '';
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  width: 0;
  height: 0;
  border-left: 5px solid transparent;
  border-right: 5px solid transparent;
  border-top: 5px solid currentColor;
  opacity: 0.6;
  pointer-events: none;
}
.hero-checkboxes {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  margin-top: 4px;
  padding: 12px;
  max-height: 400px;
  overflow-y: auto;
  display: none;
  z-index: 101;
  box-shadow: 0 4px 20px rgba(0,0,0,.15);
}
.hero-checkboxes.show {
  display: block;
}
.hero-checkboxes-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
  padding-bottom: 10px;
  border-bottom: 1px solid var(--border-color);
}
.hero-checkboxes-header h3 {
  margin: 0;
  font-size: 14px;
  font-weight: 600;
  color: var(--text-color);
}
.hero-checkbox-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 8px;
  cursor: pointer;
  border-radius: 4px;
  transition: background 0.2s;
}
.hero-checkbox-item:hover {
  background: var(--secondary-color);
}
.hero-checkbox-item input[type="checkbox"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
  accent-color: var(--primary-color);
}
.hero-checkbox-item label {
  flex: 1;
  cursor: pointer;
  font-size: 14px;
  color: var(--text-color);
}
.hero-select-actions {
  display: flex;
  gap: 8px;
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid var(--border-color);
}
.hero-select-actions .btn {
  flex: 1;
  font-size: 13px;
  padding: 8px;
}
.hero-selected-count {
  font-size: 12px;
  color: var(--primary-color);
  font-weight: 500;
}

/* Поиск */
.search-wrapper {
  flex: 1;
  min-width: 180px;
}
.search-wrapper input {
  width: 100%;
  padding: 8px 12px;
  font-size: 14px;
  border: 1px solid var(--checkbox-border);
  border-radius: 8px;
  background: var(--card-bg);
  color: var(--text-color);
  transition: all 0.2s;
}
.search-wrapper input:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 2px rgba(10, 119, 0, 0.1);
}

/* Правая группа: сортировка + кнопки */
.right-group {
  display: flex;
  align-items: center;
  gap: 16px;
  flex-shrink: 0;
}

/* Группа сортировки */
.sort-group {
  display: flex;
  align-items: center;
  gap: 8px;
}
.sort-select-wrapper {
  position: relative;
}
.sort-select-wrapper select {
  padding: 8px 36px 8px 12px;
  font-size: 14px;
  border: 1px solid var(--checkbox-border);
  border-radius: 8px;
  background: var(--card-bg);
  color: var(--text-color);
  cursor: pointer;
  appearance: none;
  min-width: 120px;
}
.sort-select-wrapper:after {
  content: '';
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  width: 0;
  height: 0;
  border-left: 5px solid transparent;
  border-right: 5px solid transparent;
  border-top: 5px solid currentColor;
  opacity: 0.6;
  pointer-events: none;
}

/* Кнопка сортировки */
.sort-btn {
  width: 40px;
  height: 40px;
  padding: 0;
  border: 1px solid var(--checkbox-border);
  border-radius: 8px;
  background: var(--card-bg);
  color: var(--text-color);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  position: relative;
}
.sort-btn:hover {
  background: var(--secondary-color);
}
.sort-btn:before {
  content: attr(data-tooltip);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  padding: 6px 10px;
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 4px;
  font-size: 12px;
  white-space: nowrap;
  opacity: 0;
  visibility: hidden;
  transition: all 0.2s;
  pointer-events: none;
  z-index: 10;
}
.sort-btn:hover:before {
  opacity: 1;
  visibility: visible;
  margin-bottom: 8px;
}
.sort-btn.asc:after {
  content: '↑';
  font-size: 16px;
}
.sort-btn.desc:after {
  content: '↓';
  font-size: 16px;
}

/* Группа кнопок фильтров */
.filter-buttons {
  display: flex;
  gap: 8px;
  align-items: center;
}
.btn {
  padding: 8px 16px;
  font-size: 14px;
  border: 1px solid var(--checkbox-border);
  border-radius: 8px;
  background: var(--card-bg);
  color: var(--text-color);
  cursor: pointer;
  transition: all 0.2s;
  font-weight: 500;
  white-space: nowrap;
}
.btn:hover {
  background: var(--secondary-color);
}
.btn.primary {
  background: var(--accent-color);
  color: #fff;
  border-color: var(--accent-color);
}
.btn.primary:hover {
  background: #1d4ed8;
  border-color: #1d4ed8;
}
.btn.secondary {
  background: var(--card-bg);
  color: var(--text-color);
  border-color: var(--checkbox-border);
}
.btn.secondary:hover {
  background: var(--secondary-color);
}

/* Кнопка информации */
.info-btn-wrapper {
  margin-left: 8px;
}
.info-btn {
  width: 40px;
  height: 40px;
  padding: 0;
  border: 1px solid var(--checkbox-border);
  border-radius: 8px;
  background: var(--card-bg);
  color: var(--text-color);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  font-weight: bold;
  font-size: 16px;
}
.info-btn:hover {
  background: var(--secondary-color);
}

/* Мобильная версия */
@media (max-width: 1024px) {
  .container {
    padding: 0 12px;
  }
  
  .top-bar {
    flex-wrap: wrap;
    gap: 12px;
    padding: 10px 0;
  }
  
  .brand {
    width: 100%;
    text-align: center;
    margin-bottom: 8px;
  }
  .copyright {
    display: none; /* Скрываем копирайт на мобильных */
  }
  
  .center-group {
    order: 1;
    width: 100%;
    max-width: none;
  }
  
  .right-group {
    order: 2;
    width: 100%;
    justify-content: space-between;
  }
  
  .sort-group {
    flex: 1;
  }
  .sort-select-wrapper {
    flex: 1;
  }
  .sort-select-wrapper select {
    width: 100%;
    min-width: 0;
  }
  
  .filter-buttons {
    flex-shrink: 0;
  }
  
  .info-btn-wrapper {
    flex-shrink: 0;
  }
}

@media (max-width: 640px) {
  .top-bar {
    gap: 8px;
  }
  
  .center-group {
    flex-direction: column;
    gap: 8px;
  }
  
  .right-group {
    flex-wrap: wrap;
    gap: 8px;
  }
  
  .sort-group {
    width: 100%;
    order: 1;
  }
  
  .filter-buttons {
    width: 100%;
    order: 2;
    justify-content: flex-start;
  }
  
  .info-btn-wrapper {
    order: 3;
    margin-left: auto;
  }
  
  .btn, .sort-select-wrapper select, .hero-select-toggle, .search-wrapper input {
    font-size: 13px;
    padding: 7px 10px;
  }
  
  .sort-btn, .info-btn {
    width: 36px;
    height: 36px;
  }
}

/* Основная сетка */
.wrap { 
  display:block; 
  padding:20px; 
  min-height: calc(100vh - var(--hdrH));
  max-width: 1400px;
  margin: 0 auto;
}
@media (max-width: 1024px) { 
  .wrap { 
    padding: 16px;
    min-height: auto;
  } 
}

/* Фильтры */
.filters { 
  background: var(--filter-bg); 
  border:1px solid var(--border-color); 
  border-radius:12px;
  box-shadow: 0 2px 10px rgba(0,0,0,.05);
  width: 320px;
  position: fixed;
  top: var(--hdrH);
  left: 0;
  bottom: 0;
  max-height: calc(100vh - var(--hdrH));
  overflow: hidden;
  z-index: 99;
  border-radius: 0 12px 12px 0;
  box-shadow: 2px 0 15px rgba(0,0,0,.1);
  transform: translateX(-100%);
  transition: transform 0.3s ease;
  display: none;
}
.filters.show {
  transform: translateX(0);
  display: block;
}
.filters .panel { 
  padding:16px; 
  background: var(--filter-bg);
  display: flex;
  flex-direction: column;
  height: 100%;
  overflow-y: auto;
}
.filters .head { 
  display:flex; 
  align-items:center; 
  justify-content:space-between; 
  margin-bottom:16px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--border-color);
  background: var(--filter-bg);
  flex-shrink: 0;
}
.filters h2 { 
  margin:0; 
  font-size:18px; 
  font-weight: 600;
  color: var(--text-color);
}
.facet { 
  margin-bottom:20px; 
  background: var(--filter-bg);
  padding: 0;
  flex-shrink: 0;
}
.facet h3 { 
  margin:0 0 10px; 
  font-size:15px; 
  color: var(--text-color);
  font-weight: 500;
  background: var(--filter-bg);
  padding: 0;
}
.opts { 
  max-height:200px; 
  overflow-y: auto;
  overflow-x: hidden;
  border:1px solid var(--border-color); 
  border-radius:8px; 
  padding:8px; 
  background: var(--secondary-color);
}
.opt { 
  display:flex; 
  align-items:center; 
  gap:8px; 
  margin-bottom:6px; 
  font-size:14px; 
  cursor: pointer;
  padding: 4px 6px;
  border-radius: 4px;
  transition: background 0.2s;
  background: transparent;
  color: var(--text-color);
}
.opt:hover {
  background: rgba(0,0,0,.1);
}
.opt input[type="checkbox"] { 
  width: 18px; 
  height: 18px; 
  cursor: pointer; 
  flex-shrink: 0;
  accent-color: var(--primary-color);
  background: var(--checkbox-bg);
  border: 1px solid var(--checkbox-border);
}
.facet .actions { 
  display:flex; 
  gap:8px; 
  margin-top:10px; 
  background: var(--filter-bg);
}
.facet .actions .btn { 
  font-size:13px; 
  padding:6px 10px; 
}

/* Кнопка Применить фильтры */
.apply-filters-container {
  margin-top: auto;
  padding-top: 16px;
  border-top: 1px solid var(--border-color);
  flex-shrink: 0;
}
.apply-filters-btn {
  width: 100%;
  padding: 12px;
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 8px;
}

/* Контент и карточки */
.content { 
  min-height:60vh; 
  width: 100%;
}
#count { 
  margin:0 0 20px; 
  color: var(--text-color);
  opacity: 0.7;
  font-size:15px;
  padding: 8px 0;
  font-weight: 500;
}

/* Адаптивная сетка карточек */
.cards { 
  display:grid; 
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); 
  gap:20px; 
  width: 100%;
}

@media (max-width: 1024px) {
  .cards { 
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); 
    gap:16px;
  }
}

@media (max-width: 768px) {
  .cards { 
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); 
    gap:14px;
  }
}

@media (max-width: 480px) {
  .cards { 
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
    gap:12px;
  }
}

.card { 
  border:1px solid var(--border-color); 
  border-radius:12px; 
  overflow:hidden; 
  background: var(--card-bg); 
  display:flex; 
  flex-direction:column; 
  transition: all 0.3s ease; 
  cursor:pointer;
  height: 100%;
  box-shadow: 0 2px 8px rgba(0,0,0,.08);
}
.card:hover { 
  box-shadow:0 8px 25px rgba(0,0,0,.12); 
  transform: translateY(-4px);
}

.thumb { 
  width:100%; 
  height: 190px;
  background: var(--secondary-color); 
  display:flex; 
  align-items:center; 
  justify-content:center; 
  overflow:hidden;
  position: relative;
}
.thumb img { 
  width: 100%;
  height: 100%;
  object-fit: contain;
  padding: 12px;
  transition: transform 0.3s;
}
.card:hover .thumb img {
  transform: scale(1.05);
}

.card h3 { 
  margin:12px 12px 6px; 
  font-size:16px; 
  font-weight: 600;
  line-height: 1.3;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  text-align: center;
  color: var(--text-color);
}

.meta { 
  margin:0 12px 6px; 
  color: var(--text-color);
  opacity: 0.8;
  display:flex; 
  gap:6px; 
  flex-wrap:wrap; 
  font-size:13px;
  line-height: 1.4;
  justify-content: center;
  text-align: center;
}
.stats { 
  margin:0 12px 12px; 
  display:flex; 
  gap:6px; 
  flex-wrap:wrap;
  justify-content: center;
}
.pill { 
  background: var(--secondary-color); 
  border:1px solid var(--border-color); 
  border-radius:999px; 
  padding:4px 8px; 
  font-size:12px;
  white-space: nowrap;
  font-weight: 500;
  color: var(--text-color);
}

/* Кнопка для раскрытия способностей в карточке */
.toggle-abilities {
  background: none;
  border: none;
  color: var(--primary-color);
  font-size: 11px;
  cursor: pointer;
  padding: 2px 6px;
  margin: 0 auto 8px;
  text-decoration: underline;
  display: block;
}
.toggle-abilities:hover {
  color: #098;
}
.card-abilities-full {
  display: none;
  font-size: 11px;
  color: var(--text-color);
  opacity: 0.8;
  padding: 0 12px 8px;
  line-height: 1.4;
  border-top: 1px solid var(--border-color);
  margin-top: 4px;
  padding-top: 8px;
}

/* Модалка */
.modal { 
  position: fixed; 
  inset: 0; 
  background: rgba(0,0,0,.85); 
  display: none; 
  align-items: center; 
  justify-content: center; 
  padding: 20px; 
  z-index: 2000; 
}
.modal.show { 
  display: flex; 
  animation: fadeIn 0.3s ease;
}
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}
.dialog { 
  position: relative; 
  background: var(--card-bg); 
  color: var(--text-color); 
  max-width: 1000px; 
  width: min(1000px, 95vw); 
  max-height: 90vh; 
  overflow: hidden; 
  border-radius: 16px; 
  box-shadow: 0 25px 50px rgba(0,0,0,.3); 
  display: flex; 
  flex-direction: column;
}
.dialog .modal-content {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 24px;
  padding: 24px;
  overflow-y: auto;
  max-height: calc(90vh - 60px);
}
.dialog .image-container {
  display: flex;
  flex-direction: column;
  align-items: center;
}
.dialog img { 
  width: 100%;
  height: auto;
  max-height: 350px;
  object-fit: contain;
  border-radius: 12px;
  background: var(--secondary-color);
  padding: 15px;
}
.dialog .info-container {
  display: flex;
  flex-direction: column;
  overflow-wrap: break-word;
  word-wrap: break-word;
  hyphens: auto;
}
.dialog h2 { 
  margin: 0 0 12px; 
  font-size:28px; 
  font-weight: 700;
  color: var(--text-color);
  line-height: 1.2;
}
.dialog .meta { 
  display:flex; 
  gap:10px; 
  flex-wrap:wrap; 
  color: var(--text-color);
  opacity: 0.8;
  margin-bottom:10px; 
  font-size:15px;
  justify-content: flex-start;
}
.dialog .mStats { 
  display:flex; 
  gap:10px; 
  flex-wrap:wrap; 
  margin:12px 0 20px;
}
.dialog .mStats .pill { 
  font-size:14px; 
  padding:8px 12px;
  background: rgba(10, 119, 0, 0.1);
  border-color: var(--primary-color);
  color: var(--primary-color);
}
.pre { 
  white-space: pre-line; 
  background: var(--secondary-color); 
  border:1px solid var(--border-color); 
  border-radius:10px; 
  padding:12px; 
  font-size:15px; 
  overflow-wrap: break-word;
  word-break: break-word;
  line-height: 1.5;
  margin: 8px 0;
}
.close { 
  position: absolute; 
  top: 12px; 
  right: 12px; 
  border: none; 
  background: rgba(0,0,0,.7); 
  color: #fff; 
  font-size: 24px; 
  line-height: 1; 
  width: 40px;
  height: 40px;
  border-radius: 50%; 
  cursor: pointer; 
  z-index: 10;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}
.close:hover {
  background: rgba(0,0,0,.9);
  transform: scale(1.1);
}
.nav { 
  position: absolute; 
  top: 50%; 
  transform: translateY(-50%); 
  border: none; 
  background: rgba(0,0,0,.7); 
  color: #fff; 
  font-size: 28px; 
  line-height: 1; 
  width: 44px;
  height: 44px;
  padding: 0;
  border-radius: 50%; 
  cursor: pointer; 
  z-index: 10; 
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}
.nav:hover {
  background: rgba(0,0,0,.9);
  transform: translateY(-50%) scale(1.1);
}
.nav.prev { left: 12px; } 
.nav.next { right: 12px; }
.open-img { 
  margin-top:12px; 
  display:inline-block; 
  font-size:14px; 
  color:var(--primary-color); 
  text-decoration:none;
  font-weight: 500;
  transition: color 0.2s;
}
.open-img:hover {
  color: #098;
  text-decoration: underline;
}

/* Мобильный оффканвас для фильтров */
@media (max-width: 1024px) {
  .filters { 
    position: fixed; 
    inset: 0; 
    background: rgba(0,0,0,.6); 
    display:none; 
    z-index:1000; 
    border:none; 
    padding: 0;
    margin: 0;
    width: 100vw;
    height: 100vh;
    transform: none;
  }
  .filters.show { 
    display:flex; 
    flex-direction: column;
  }
  .filters .panel { 
    position:relative;
    right:0; 
    top:0; 
    bottom:0; 
    width: min(380px, 90vw);
    max-width: 90vw;
    overflow:auto; 
    background: var(--filter-bg); 
    border-radius:12px 0 0 12px;
    padding: 20px;
    box-sizing: border-box;
    margin: 0;
    box-shadow: -2px 0 15px rgba(0,0,0,.1);
    height: 100%;
    flex: 1;
  }
  .filters .head { 
    position: sticky; 
    top:0; 
    background: var(--filter-bg); 
    padding-top:12px; 
    z-index:1;
    padding-bottom: 12px;
    margin: 0;
  }
}

/* Информационная модалка */
.info-modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.7);
  display: none;
  align-items: center;
  justify-content: center;
  padding: 20px;
  z-index: 2001;
}
.info-modal.show {
  display: flex;
}
.info-dialog {
  background: var(--card-bg);
  color: var(--text-color);
  border-radius: 16px;
  padding: 30px;
  max-width: 500px;
  width: 90%;
  box-shadow: 0 20px 60px rgba(0,0,0,.3);
  position: relative;
}
.info-dialog h2 {
  margin: 0 0 20px;
  color: var(--text-color);
  font-size: 24px;
  text-align: center;
}
.info-dialog p {
  margin: 0 0 15px;
  line-height: 1.6;
  color: var(--text-color);
  opacity: 0.9;
}
.info-dialog .clan {
  background: rgba(10, 119, 0, 0.1);
  padding: 15px;
  border-radius: 10px;
  margin: 20px 0;
  text-align: center;
  border: 1px solid var(--primary-color);
}
.info-dialog .clan strong {
  color: var(--primary-color);
  font-size: 18px;
}
.info-dialog .contact {
  background: rgba(0, 0, 0, 0.05);
  padding: 15px;
  border-radius: 10px;
  margin: 20px 0;
  text-align: center;
  border: 1px solid var(--border-color);
}
.info-dialog .contact a {
  color: var(--primary-color);
  text-decoration: none;
  font-weight: 500;
}
.info-dialog .contact a:hover {
  text-decoration: underline;
}
.info-dialog .date {
  text-align: center;
  font-style: italic;
  color: var(--text-color);
  opacity: 0.6;
  margin-top: 20px;
  padding-top: 15px;
  border-top: 1px solid var(--border-color);
}
.info-close {
  position: absolute;
  top: 15px;
  right: 15px;
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: var(--text-color);
  opacity: 0.7;
  transition: all 0.2s;
}
.info-close:hover {
  opacity: 1;
  color: var(--text-color);
}

/* Подложка при открытых фильтрах на десктопе */
@media (min-width: 1025px) {
  .filters.show ~ .wrap::before {
    content: '';
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.5);
    z-index: 98;
    pointer-events: none;
  }
}
</style>
</head>
<body>
<header>
  <div class="container">
    <div class="top-bar">
      <!-- Логотип и копирайт -->
      <div class="brand">
        <h1>Время Героев. Галерея героев.</h1>
        <div class="copyright">Евгений Поташко и Владимир Плотников, клан "Рожденные в СССР."</div>
      </div>
      
      <!-- Центральная группа: выбор героя + поиск -->
      <div class="center-group">
        <!-- Выбор героя -->
        <div class="hero-select-wrapper">
          <div class="hero-select-container">
            <button id="heroSelectToggle" class="hero-select-toggle" aria-label="Выбор героя">
              <span id="heroSelectText">Выберите героя</span>
            </button>
            <div id="heroCheckboxes" class="hero-checkboxes">
              <div class="hero-checkboxes-header">
                <h3>Выберите героев</h3>
                <span id="heroSelectedCount" class="hero-selected-count">0 выбрано</span>
              </div>
              <div id="heroCheckboxesList"></div>
              <div class="hero-select-actions">
                <button id="selectAllHeroes" class="btn">Выбрать все</button>
                <button id="deselectAllHeroes" class="btn">Снять все</button>
                <button id="applyHeroSelection" class="btn primary">Применить</button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Поиск -->
        <div class="search-wrapper">
          <input id="searchInput" type="search" placeholder="Поиск по имени/способности">
        </div>
      </div>
      
      <!-- Правая группа: сортировка + кнопки + информация -->
      <div class="right-group">
        <!-- Группа сортировки -->
        <div class="sort-group">
          <div class="sort-select-wrapper">
            <select id="sortSelect">
              <option value="Сила">Сила</option>
              <option value="Атака">Атака</option>
              <option value="Защита">Защита</option>
              <option value="Жизни">Жизни</option>
              <option value="Герой">Имя</option>
            </select>
          </div>
          <button id="sortBtn" class="sort-btn desc" data-tooltip="Сортировка по убыванию"></button>
        </div>
        
        <!-- Группа кнопок фильтров -->
        <div class="filter-buttons">
          <button id="openFilters" class="btn primary">Фильтры</button>
          <button id="resetAll" class="btn secondary">Сбросить</button>
        </div>
        
        <!-- Кнопка информации -->
        <div class="info-btn-wrapper">
          <button id="infoBtn" class="info-btn" title="Информация">i</button>
        </div>
      </div>
    </div>
  </div>
</header>

<!-- Фильтры (скрытая панель на всех устройствах) -->
<aside id="filters" class="filters">
<div class="panel">
<div class="head">
<h2>Фильтры</h2>
<div style="display: flex; gap: 8px;">
  <button id="applyFiltersBtn" class="btn primary" style="flex: 1;">Применить</button>
  <button id="closeFilters" class="btn">Закрыть</button>
</div>
</div>
<div class="facet" data-facet="element">
      <h3>Стихия</h3>
      <div class="opts" id="facet-element"></div>
      <div class="actions">
        <button class="btn" data-action="all" data-facet="element">Все</button>
        <button class="btn" data-action="none" data-facet="element">Снять</button>
      </div>
    </div>

    <div class="facet" data-facet="stars">
      <h3>Количество звезд</h3>
      <div class="opts" id="facet-stars"></div>
      <div class="actions">
        <button class="btn" data-action="all" data-facet="stars">Все</button>
        <button class="btn" data-action="none" data-facet="stars">Снять</button>
      </div>
    </div>

    <div class="facet" data-facet="mana">
      <h3>Скорость маны</h3>
      <div class="opts" id="facet-mana"></div>
      <div class="actions">
        <button class="btn" data-action="all" data-facet="mana">Все</button>
        <button class="btn" data-action="none" data-facet="mana">Снять</button>
      </div>
    </div>

    <div class="facet" data-facet="attackType">
      <h3>Способ атаки</h3>
      <div class="opts" id="facet-attackType"></div>
      <div class="actions">
        <button class="btn" data-action="all" data-facet="attackType">Все</button>
        <button class="btn" data-action="none" data-facet="attackType">Снять</button>
      </div>
    </div>

    <div class="facet" data-facet="summon">
      <h3>Место призыва</h3>
      <div class="opts" id="facet-summon"></div>
      <div class="actions">
        <button class="btn" data-action="all" data-facet="summon">Все</button>
        <button class="btn" data-action="none" data-facet="summon">Снять</button>
      </div>
    </div>

    <div class="facet" data-facet="clazz">
      <h3>Класс</h3>
      <div class="opts" id="facet-clazz"></div>
      <div class="actions">
        <button class="btn" data-action="all" data-facet="clazz">Все</button>
        <button class="btn" data-action="none" data-facet="clazz">Снять</button>
      </div>
    </div>
    
    <div class="apply-filters-container">
      <button id="applyFiltersMobileBtn" class="btn primary apply-filters-btn">Применить фильтры</button>
    </div>
  </div>
</aside>

<div class="wrap">
<!-- Контент -->
<section class="content">
  <div id="count">Загрузка...</div>
  <div id="cards" class="cards"></div>
  <div id="empty" style="display:none; color:#666; padding:24px;">Ничего не найдено. Измените фильтры.</div>
</section>
</div>

<!-- Модалка карточки -->
<div id="modal" class="modal" role="dialog" aria-modal="true">
<div class="dialog">
<button id="mClose" class="close" aria-label="Закрыть">×</button>
<button id="mPrev" class="nav prev" aria-label="Предыдущий">‹</button>
<button id="mNext" class="nav next" aria-label="Следующий">›</button>
<div class="modal-content">
  <div class="image-container">
    <img id="mImg" src="" alt="">
    <a id="mOpenImg" class="open-img" href="#" target="_blank" rel="noopener">Открыть изображение в новой вкладке</a>
  </div>
  <div class="info-container">
    <h2 id="mName"></h2>
    <div id="mMeta1" class="meta"></div>
    <div id="mMeta2" class="meta"></div>
    <div id="mStats" class="mStats"></div>
    <h3>Способности</h3>
    <div id="mAbilities" class="pre"></div>
    <h3>Пассивные способности</h3>
    <div id="mPassive" class="pre"></div>
  </div>
</div>
</div>
</div>

<!-- Модалка информации -->
<div id="infoModal" class="info-modal">
  <div class="info-dialog">
    <button id="infoClose" class="info-close" aria-label="Закрыть">×</button>
    <h2>О галерее героев</h2>
    <p>Эта галерея содержит информацию о героях игры "Время Героев", их характеристиках и способностях.</p>
    <div class="clan">
      <strong>Разработано:</strong><br>
      Евгений Поташко и Владимир Плотников<br>
      <strong>Клан: "Рожденные в СССР."</strong><br>
      скрины героев предоставлены великим и могучим Козырем
    </div>
    <div class="contact">
      <strong>Обратная связь:</strong><br>
      Нашли ошибку или есть предложения?<br>
      Пишите: <a href="mailto:master-Erasm@yandex.ru">master-Erasm@yandex.ru</a>
    </div>
    <p>База данных регулярно обновляется с учетом новых героев и изменений в балансе игры.</p>
    <p class="date">Дата последнего обновления: <span id="updateDate"></span></p>
  </div>
</div>

<script>
// Имена колонок (точно как в CSV)
const F = {
id: 'id',
name: 'Герой',
element: 'Стихия',
stars: 'Количество звезд',
mana: 'Скорость маны',
power: 'Сила',
attack: 'Атака',
defense: 'Защита',
hp: 'Жизни',
attackType: 'Способ атаки',
abilities: 'Способности',
passive: 'Пассивные способности',
summon: 'Место призыва',
clazz: 'Класс',
image: 'Картинка'
};
const DATA_URL = 'heroes.csv?ts=' + Date.now();

const els = {
  searchInput: document.getElementById('searchInput'),
  sortSelect: document.getElementById('sortSelect'),
  sortBtn: document.getElementById('sortBtn'),
  resetAll: document.getElementById('resetAll'),
  openFilters: document.getElementById('openFilters'),
  closeFilters: document.getElementById('closeFilters'),
  applyFiltersBtn: document.getElementById('applyFiltersBtn'),
  applyFiltersMobileBtn: document.getElementById('applyFiltersMobileBtn'),
  heroSelectToggle: document.getElementById('heroSelectToggle'),
  heroSelectText: document.getElementById('heroSelectText'),
  heroCheckboxes: document.getElementById('heroCheckboxes'),
  heroCheckboxesList: document.getElementById('heroCheckboxesList'),
  heroSelectedCount: document.getElementById('heroSelectedCount'),
  selectAllHeroes: document.getElementById('selectAllHeroes'),
  deselectAllHeroes: document.getElementById('deselectAllHeroes'),
  applyHeroSelection: document.getElementById('applyHeroSelection'),
  filters: document.getElementById('filters'),
  count: document.getElementById('count'),
  cards: document.getElementById('cards'),
  empty: document.getElementById('empty'),
  facet: {
    element: document.getElementById('facet-element'),
    stars: document.getElementById('facet-stars'),
    mana: document.getElementById('facet-mana'),
    attackType: document.getElementById('facet-attackType'),
    summon: document.getElementById('facet-summon'),
    clazz: document.getElementById('facet-clazz'),
  },
  modal: document.getElementById('modal'),
  mClose: document.getElementById('mClose'),
  mPrev: document.getElementById('mPrev'),
  mNext: document.getElementById('mNext'),
  mImg: document.getElementById('mImg'),
  mOpenImg: document.getElementById('mOpenImg'),
  mName: document.getElementById('mName'),
  mMeta1: document.getElementById('mMeta1'),
  mMeta2: document.getElementById('mMeta2'),
  mStats: document.getElementById('mStats'),
  mAbilities: document.getElementById('mAbilities'),
  mPassive: document.getElementById('mPassive'),
  infoModal: document.getElementById('infoModal'),
  infoBtn: document.getElementById('infoBtn'),
  infoClose: document.getElementById('infoClose'),
  updateDate: document.getElementById('updateDate')
};

let allRows = [];
let viewRows = [];
let currentIdx = -1;
let allHeroNames = [];
let filteredHeroNames = [];
let sortDirection = 'desc'; // 'asc' или 'desc'

const selected = {
  element: new Set(),
  stars: new Set(),
  mana: new Set(),
  attackType: new Set(),
  summon: new Set(),
  clazz: new Set(),
  heroes: new Set()
};

function toNum(v){ const n = Number(String(v).replace(',', '.')); return Number.isFinite(n) ? n : null; }
function uniq(values){ return [...new Set(values.filter(v => v!==undefined && v!==null && String(v).trim()!==''))]; }
function sortAlpha(a,b){ return String(a).localeCompare(String(b), 'ru', {numeric:true}); }

// Функция для сортировки скорости маны в заданном порядке
function sortMana(a, b) {
  const order = ['Очень медленно', 'Медленно', 'Средне', 'Быстро', 'Очень быстро', 'Легендарно быстро'];
  const indexA = order.indexOf(a);
  const indexB = order.indexOf(b);
  
  if (indexA === -1 && indexB === -1) return String(a).localeCompare(String(b), 'ru');
  if (indexA === -1) return 1;
  if (indexB === -1) return -1;
  
  return indexA - indexB;
}

function sortNumericAsc(a,b){ const na=toNum(a), nb=toNum(b); return (na??Infinity) - (nb??Infinity); }

function fileCellToUrl(v){
  if (!v) return '';
  const s = String(v).trim();
  const mParen = s.match(/\((https?:\/\/[^)]+)\)/i);
  if (mParen) return mParen[1];
  const mAny = s.match(/https?:\/\/\S+/i);
  if (mAny) return mAny[0].replace(/[),]+$/,'');
  try {
    const arr = JSON.parse(s);
    if (Array.isArray(arr) && arr.length && arr[0].url) return arr[0].url;
  } catch(e){}
  return '';
}

// Функция для обновления отображения выбранных героев
function updateHeroSelectDisplay() {
  const count = selected.heroes.size;
  els.heroSelectedCount.textContent = `${count} выбрано`;
  
  if (count === 0) {
    els.heroSelectText.textContent = 'Выберите героя';
  } else if (count === 1) {
    const heroName = Array.from(selected.heroes)[0];
    els.heroSelectText.textContent = heroName;
  } else if (count === allHeroNames.length) {
    els.heroSelectText.textContent = 'Все герои';
  } else {
    const firstHero = Array.from(selected.heroes)[0];
    els.heroSelectText.textContent = `${firstHero} и еще ${count - 1}`;
  }
}

// Функция для обновления чекбоксов героев
function updateHeroCheckboxes() {
  const heroNamesToShow = filteredHeroNames.length > 0 ? filteredHeroNames : allHeroNames;
  
  els.heroCheckboxesList.innerHTML = heroNamesToShow.map(name => {
    const isSelected = selected.heroes.has(name);
    return `
      <div class="hero-checkbox-item">
        <input type="checkbox" id="hero-${name}" data-hero="${name}" ${isSelected ? 'checked' : ''}>
        <label for="hero-${name}">${name}</label>
      </div>
    `;
  }).join('');
  
  els.heroCheckboxesList.querySelectorAll('input[type="checkbox"]').forEach(cb => {
    cb.addEventListener('change', function() {
      const heroName = this.getAttribute('data-hero');
      if (this.checked) {
        selected.heroes.add(heroName);
      } else {
        selected.heroes.delete(heroName);
      }
      updateHeroSelectDisplay();
    });
  });
  
  updateHeroSelectDisplay();
}

function buildFacet(container, values, facetKey){
  let opts = uniq(values);
  
  if (facetKey === 'mana') {
    opts.sort(sortMana);
  } else if (facetKey === 'stars') {
    opts.sort(sortNumericAsc);
  } else {
    opts.sort(sortAlpha);
  }
  
  container.innerHTML = opts.map(val => {
    const checked = selected[facetKey].size ? (selected[facetKey].has(String(val)) ? 'checked' : '') : '';
    return `<label class="opt"><input type="checkbox" data-facet="${facetKey}" value="${String(val).replace(/"/g,'&quot;')}" ${checked}><span>${String(val)}</span></label>`;
  }).join('');
  
  container.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
    cb.addEventListener('change', ()=>{
      const set = selected[facetKey];
      if (cb.checked) set.add(cb.value); else set.delete(cb.value);
    });
  });
}

function initAllFacets(rows){
  buildFacet(els.facet.element, rows.map(r=>r[F.element]), 'element');
  buildFacet(els.facet.stars,   rows.map(r=>r[F.stars]),   'stars');
  buildFacet(els.facet.mana,    rows.map(r=>r[F.mana]),    'mana');
  buildFacet(els.facet.attackType, rows.map(r=>r[F.attackType]), 'attackType');
  buildFacet(els.facet.summon,  rows.map(r=>r[F.summon]),  'summon');
  buildFacet(els.facet.clazz,   rows.map(r=>r[F.clazz]),   'clazz');
  
  allHeroNames = uniq(rows.map(r => r[F.name])).sort(sortAlpha);
  filteredHeroNames = [...allHeroNames];
  updateHeroCheckboxes();
}

function selectAll(facetKey){
  const values = uniq(allRows.map(r=>{
    switch(facetKey){
      case 'element': return r[F.element];
      case 'stars': return r[F.stars];
      case 'mana': return r[F.mana];
      case 'attackType': return r[F.attackType];
      case 'summon': return r[F.summon];
      case 'clazz': return r[F.clazz];
      default: return null;
    }
  })).filter(v => v !== null);
  
  selected[facetKey] = new Set(values.map(String));
  initAllFacets(allRows);
}

function selectNone(facetKey){
  selected[facetKey].clear();
  initAllFacets(allRows);
}

function renderCards(rows){
  if (!rows.length){
    els.cards.innerHTML = '';
    els.empty.style.display = 'block';
    return;
  }
  els.empty.style.display = 'none';
  els.cards.innerHTML = rows.map((r, i)=>{
    const img = fileCellToUrl(r[F.image]);
    const abilitiesFull = String(r[F.abilities]||'');
    const hasAbilities = abilitiesFull.trim().length > 0;
    
    return `
      <article class="card" data-idx="${i}">
        <div class="thumb">
          ${img ? `<img src="${img}" alt="${r[F.name]||''}" loading="lazy" onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML='<div style=\\'color: #999; padding: 20px; text-align: center;\\'>Нет изображения</div>';" />` : '<div style="color: #999; padding: 20px; text-align: center;">Нет изображения</div>'}
        </div>
        <h3>${r[F.name]||''}</h3>
        <div class="meta">
          <span>${r[F.element]||''}</span> •
          <span>${r[F.stars]||''}★</span> •
          <span>${r[F.mana]||''}</span>
        </div>
        <div class="meta">
          <span>${r[F.attackType]||''}</span> •
          <span>${r[F.summon]||''}</span> •
          <span>${r[F.clazz]||''}</span>
        </div>
        <div class="stats">
          <span class="pill">С: ${r[F.power]||''}</span>
          <span class="pill">А: ${r[F.attack]||''}</span>
          <span class="pill">З: ${r[F.defense]||''}</span>
          <span class="pill">Ж: ${r[F.hp]||''}</span>
        </div>
        ${hasAbilities ? `
          <button class="toggle-abilities" data-idx="${i}">Показать способности</button>
          <div class="card-abilities-full" id="abilities-${i}">${abilitiesFull.replace(/\n/g, '<br>')}</div>
        ` : ''}
      </article>
    `;
  }).join('');
  
  document.querySelectorAll('.toggle-abilities').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      const idx = this.getAttribute('data-idx');
      const fullAbilities = document.getElementById(`abilities-${idx}`);
      if (fullAbilities.style.display === 'block') {
        fullAbilities.style.display = 'none';
        this.textContent = 'Показать способности';
      } else {
        fullAbilities.style.display = 'block';
        this.textContent = 'Скрыть способности';
      }
    });
  });
}

function fillModal(h){
  const img = fileCellToUrl(h[F.image]);
  els.mImg.src = img || '';
  els.mImg.alt = h[F.name] || '';
  els.mOpenImg.href = img || '#';
  els.mOpenImg.style.display = img ? 'inline-block' : 'none';

  els.mName.textContent = h[F.name] || '';
  els.mMeta1.innerHTML = `
    <span>${h[F.element]||''}</span>
    <span>${(h[F.stars]||'') ? (h[F.stars]+'★') : ''}</span>
    <span>${h[F.mana]||''}</span>
  `;
  els.mMeta2.innerHTML = `
    <span>${h[F.attackType]||''}</span>
    <span>${h[F.summon]||''}</span>
    <span>${h[F.clazz]||''}</span>
  `;
  els.mStats.innerHTML = `
    <span class="pill">Сила: ${h[F.power]||''}</span>
    <span class="pill">АТК: ${h[F.attack]||''}</span>
    <span class="pill">ЗАЩ: ${h[F.defense]||''}</span>
    <span class="pill">HP: ${h[F.hp]||''}</span>
  `;
  els.mAbilities.textContent = h[F.abilities] || '—';
  els.mPassive.textContent = h[F.passive] || '—';
}

function openModal(idx){
  if (!viewRows.length) return;
  currentIdx = idx;
  fillModal(viewRows[currentIdx]);
  els.modal.classList.add('show');
  document.body.style.overflow = 'hidden';
}

function closeModal(){
  els.modal.classList.remove('show');
  document.body.style.overflow = '';
  currentIdx = -1;
}

function go(delta){
  if (currentIdx < 0 || !viewRows.length) return;
  currentIdx = (currentIdx + delta + viewRows.length) % viewRows.length;
  fillModal(viewRows[currentIdx]);
}

function applyFilters(){
  const q = els.searchInput.value.trim().toLowerCase();
  
  viewRows = allRows.filter(r=>{
    const tName = String(r[F.name]||'').toLowerCase();
    const tAbil = String(r[F.abilities]||'').toLowerCase();
    const passQ = !q || tName.includes(q) || tAbil.includes(q);
    const passElem   = selected.element.size===0   || selected.element.has(String(r[F.element]));
    const passStars  = selected.stars.size===0     || selected.stars.has(String(r[F.stars]));
    const passMana   = selected.mana.size===0      || selected.mana.has(String(r[F.mana]));
    const passAtkT   = selected.attackType.size===0|| selected.attackType.has(String(r[F.attackType]));
    const passSummon = selected.summon.size===0    || selected.summon.has(String(r[F.summon]));
    const passClazz  = selected.clazz.size===0     || selected.clazz.has(String(r[F.clazz]));
    const passHeroes = selected.heroes.size===0    || selected.heroes.has(String(r[F.name]));
    
    return passQ && passElem && passStars && passMana && passAtkT && passSummon && passClazz && passHeroes;
  });

  const by = els.sortSelect.value;
  
  viewRows.sort((a,b)=>{
    const av = a[by], bv = b[by];
    const an = toNum(av), bn = toNum(bv);
    let cmp;
    if (an!=null && bn!=null) cmp = an - bn;
    else cmp = String(av||'').localeCompare(String(bv||''), 'ru', {numeric:true});
    return sortDirection === 'asc' ? cmp : -cmp;
  });

  els.count.textContent = `Найдено: ${viewRows.length}`;
  renderCards(viewRows);
  
  filteredHeroNames = uniq(viewRows.map(r => r[F.name])).sort(sortAlpha);
  updateHeroCheckboxes();
}

function attachEvents(){
  // Поиск
  els.searchInput.addEventListener('input', applyFilters);
  
  // Сортировка
  els.sortSelect.addEventListener('change', applyFilters);
  
  // Кнопка сортировки
  els.sortBtn.addEventListener('click', () => {
    if (sortDirection === 'desc') {
      sortDirection = 'asc';
      els.sortBtn.className = 'sort-btn asc';
      els.sortBtn.setAttribute('data-tooltip', 'Сортировка по возрастанию');
    } else {
      sortDirection = 'desc';
      els.sortBtn.className = 'sort-btn desc';
      els.sortBtn.setAttribute('data-tooltip', 'Сортировка по убыванию');
    }
    applyFilters();
  });
  
  // Обработчики для выбора героев
  els.heroSelectToggle.addEventListener('click', (e) => {
    els.heroSelectToggle.classList.toggle('show');
    els.heroCheckboxes.classList.toggle('show');
    e.stopPropagation();
  });
  
  els.selectAllHeroes.addEventListener('click', () => {
    selected.heroes = new Set(filteredHeroNames);
    updateHeroCheckboxes();
  });
  
  els.deselectAllHeroes.addEventListener('click', () => {
    selected.heroes.clear();
    updateHeroCheckboxes();
  });
  
  els.applyHeroSelection.addEventListener('click', () => {
    els.heroSelectToggle.classList.remove('show');
    els.heroCheckboxes.classList.remove('show');
    applyFilters();
  });
  
  document.addEventListener('click', (e) => {
    if (!els.heroSelectToggle.contains(e.target) && !els.heroCheckboxes.contains(e.target)) {
      els.heroSelectToggle.classList.remove('show');
      els.heroCheckboxes.classList.remove('show');
    }
  });
  
  document.querySelectorAll('.facet .actions button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const facetKey = btn.dataset.facet;
      if (btn.dataset.action === 'all') selectAll(facetKey);
      else selectNone(facetKey);
    });
  });
  
  els.resetAll.addEventListener('click', ()=>{
    els.searchInput.value = '';
    els.sortSelect.value = 'Сила';
    sortDirection = 'desc';
    els.sortBtn.className = 'sort-btn desc';
    els.sortBtn.setAttribute('data-tooltip', 'Сортировка по убыванию');
    Object.keys(selected).forEach(k => selected[k].clear());
    filteredHeroNames = [...allHeroNames];
    initAllFacets(allRows);
    applyFilters();
  });
  
  // Кнопка "Применить" в фильтрах
  els.applyFiltersBtn.addEventListener('click', () => {
    applyFilters();
    els.filters.classList.remove('show');
    document.body.style.overflow = '';
  });
  
  els.applyFiltersMobileBtn.addEventListener('click', () => {
    applyFilters();
    els.filters.classList.remove('show');
    document.body.style.overflow = '';
  });
  
  els.cards.addEventListener('click', (e)=>{
    if (e.target.classList.contains('toggle-abilities')) {
      return;
    }
    const card = e.target.closest('.card');
    if (!card) return;
    const idx = Number(card.dataset.idx);
    if (Number.isFinite(idx)) openModal(idx);
  });
  
  els.mClose.addEventListener('click', closeModal);
  els.mPrev.addEventListener('click', ()=>go(-1));
  els.mNext.addEventListener('click', ()=>go(1));
  
  els.modal.addEventListener('click', (e)=>{
    if (e.target === els.modal) closeModal();
  });
  
  window.addEventListener('keydown', (e)=>{
    if (!els.modal.classList.contains('show')) return;
    if (e.key === 'Escape') closeModal();
    if (e.key === 'ArrowLeft') go(-1);
    if (e.key === 'ArrowRight') go(1);
  });
  
  // Обработка фильтров
  els.openFilters.addEventListener('click', ()=>{
    els.filters.classList.add('show');
    document.body.style.overflow = 'hidden';
  });
  
  els.closeFilters.addEventListener('click', ()=>{
    els.filters.classList.remove('show');
    document.body.style.overflow = '';
  });
  
  els.filters.addEventListener('click', (e)=>{
    if (e.target === els.filters) {
      els.filters.classList.remove('show');
      document.body.style.overflow = '';
    }
  });
  
  // Информационная модалка
  els.infoBtn.addEventListener('click', ()=>{
    els.infoModal.classList.add('show');
    document.body.style.overflow = 'hidden';
  });
  
  els.infoClose.addEventListener('click', ()=>{
    els.infoModal.classList.remove('show');
    document.body.style.overflow = '';
  });
  
  els.infoModal.addEventListener('click', (e)=>{
    if (e.target === els.infoModal) {
      els.infoModal.classList.remove('show');
      document.body.style.overflow = '';
    }
  });
  
  // Устанавливаем дату обновления
  const now = new Date();
  const options = { year: 'numeric', month: 'long', day: 'numeric' };
  els.updateDate.textContent = now.toLocaleDateString('ru-RU', options);
}

Papa.parse(DATA_URL, {
  download:true,
  header:true,
  skipEmptyLines:true,
  complete: (res)=>{
    allRows = res.data || [];
    if (!allRows.length){ 
      els.count.textContent = 'Данные не найдены. Проверьте heroes.csv'; 
      return; 
    }
    initAllFacets(allRows);
    attachEvents();
    applyFilters();
  },
  error: (e)=> { 
    console.error('Ошибка CSV:', e); 
    els.count.textContent = 'Ошибка загрузки CSV.'; 
  }
});
</script>
</body>
</html>
